<div class="relative">
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <!-- MapPin Icon -->
            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" />
                <circle cx="12" cy="10" r="3" />
            </svg>
        </div>
        <input type="text" [value]="searchQuery" (input)="onInput($event)" (focus)="onFocus()" (blur)="onBlur()"
            class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [class.border-red-300]="required && !searchQuery && !isFocused" [placeholder]="placeholder" />

        <!-- Loading Spinner -->
        <div *ngIf="loading" class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <svg class="h-5 w-5 text-gray-400 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M21 12a9 9 0 11-6.219-8.56" />
            </svg>
        </div>

        <!-- Clear Button -->
        <button *ngIf="!loading && searchQuery" type="button" (click)="handleClear()"
            class="absolute inset-y-0 right-0 pr-3 flex items-center hover:text-gray-600">
            <svg class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        </button>
    </div>

    <!-- Suggestions Dropdown -->
    <div *ngIf="showSuggestions && suggestions.length > 0"
        class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto">
        <button *ngFor="let location of suggestions" type="button" (click)="selectLocation(location)"
            class="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-100 last:border-b-0 transition-colors">
            <div class="flex items-start">
                <!-- MapPin Icon -->
                <svg class="h-5 w-5 text-blue-500 mr-3 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" />
                    <circle cx="12" cy="10" r="3" />
                </svg>
                <div class="flex-1 min-w-0">
                    <!-- Primary location name -->
                    <div class="font-medium text-gray-900 truncate">
                        {{ location.specificName || location.addressLine || location.venue || location.building ||
                        location.displayName }}
                    </div>

                    <!-- Address details -->
                    <div *ngIf="location.addressLine && location.specificName && location.addressLine !== location.specificName"
                        class="text-sm text-gray-600 truncate mt-0.5">
                        {{ location.addressLine }}
                    </div>

                    <!-- Location context -->
                    <div class="text-sm text-gray-500 truncate mt-0.5">
                        {{ formatLocationContext(location) }}
                    </div>

                    <!-- Place type indicator -->
                    <div *ngIf="location.venue || location.building" class="text-xs text-blue-600 mt-1">
                        {{ location.venue || location.building || 'Specific location' }}
                    </div>
                </div>
            </div>
        </button>
    </div>

    <!-- No results message -->
    <div *ngIf="showSuggestions && !loading && searchQuery.length >= 3 && suggestions.length === 0 && !apiError"
        class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg p-4 text-sm text-gray-500">
        No locations found. Try a different search term or type your location manually.
    </div>

    <!-- API Error / Manual Entry Notice -->
    <div *ngIf="apiError && searchQuery.length >= 3 && isFocused"
        class="absolute z-50 w-full mt-1 bg-yellow-50 border border-yellow-200 rounded-lg shadow-lg p-3 text-sm">
        <p class="text-yellow-800 font-medium">Location suggestions unavailable</p>
        <p class="text-yellow-700 text-xs mt-1">
            Type your location manually, then click outside to confirm.
        </p>
    </div>
</div>