<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" (click)="close.emit()">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto relative"
        (click)="$event.stopPropagation()">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <lucide-icon [img]="QrCodeIcon" class="text-primary-600 mr-3 h-6 w-6"></lucide-icon>
                    <h3 class="text-lg font-semibold text-gray-900">QR Code Scanner</h3>
                </div>
                <button (click)="close.emit()" class="text-gray-400 hover:text-gray-600 p-1">
                    <lucide-icon [img]="XCircleIcon" class="h-6 w-6"></lucide-icon>
                </button>
            </div>

            <!-- Start Screen -->
            <div *ngIf="!isScanning && !scannedData" class="text-center py-8">
                <lucide-icon [img]="CameraIcon" class="mx-auto h-16 w-16 text-gray-300 mb-4"></lucide-icon>
                <h4 class="text-lg font-medium text-gray-900 mb-2">Ready to Scan</h4>
                <p class="text-gray-600 mb-6">Position the QR code within the camera view to scan</p>
                <button (click)="startScanning()"
                    class="w-full flex items-center justify-center px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 font-medium transition-colors mb-3">
                    <lucide-icon [img]="CameraIcon" class="mr-2 h-5 w-5"></lucide-icon>
                    Start Scanning
                </button>
                <button (click)="handleManualInput()"
                    class="w-full flex items-center justify-center px-6 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
                    Enter Manually
                </button>
            </div>

            <!-- Scanner View -->
            <div *ngIf="isScanning" class="relative bg-black rounded-lg overflow-hidden">
                <video #video class="w-full h-64 object-cover"></video>
                <canvas #canvas class="hidden"></canvas>

                <!-- Overlay Guide -->
                <div class="absolute inset-0 border-2 border-primary-500 rounded-lg pointer-events-none opacity-50">
                    <div class="absolute top-2 left-2 w-6 h-6 border-t-2 border-l-2 border-primary-500"></div>
                    <div class="absolute top-2 right-2 w-6 h-6 border-t-2 border-r-2 border-primary-500"></div>
                    <div class="absolute bottom-2 left-2 w-6 h-6 border-b-2 border-l-2 border-primary-500"></div>
                    <div class="absolute bottom-2 right-2 w-6 h-6 border-b-2 border-r-2 border-primary-500"></div>
                </div>

                <div class="absolute bottom-4 left-0 right-0 flex justify-center">
                    <button (click)="stopScanning()"
                        class="bg-red-600/80 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-red-700/80 backdrop-blur-sm">
                        Stop Scanning
                    </button>
                </div>
            </div>

            <!-- Scanned Result -->
            <div *ngIf="scannedData" class="space-y-4">
                <div class="p-4 rounded-lg border-2" [ngClass]="{
                    'border-blue-200 bg-blue-50': scannedData.type === 'user_profile',
                    'border-green-200 bg-green-50': scannedData.type === 'event_checkin',
                    'border-gray-200 bg-gray-50': !['user_profile', 'event_checkin'].includes(scannedData.type)
                 }">
                    <div class="flex items-center mb-3">
                        <div class="h-10 w-10 flex items-center justify-center rounded-full mr-3 text-2xl">
                            <!-- Simple text icon for now -->
                            {{ scannedData.type === 'user_profile' ? 'üë§' : (scannedData.type === 'event_checkin' ? 'üé´'
                            : '‚ùì') }}
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">{{ getQRCodeTypeInfo(scannedData).title }}</h4>
                            <p class="text-sm text-gray-600 truncate max-w-[200px]">{{
                                getQRCodeTypeInfo(scannedData).description }}</p>
                        </div>
                    </div>

                    <div class="text-sm text-gray-700 space-y-1">
                        <p *ngIf="scannedData.userId" class="truncate"><strong>User ID:</strong> {{ scannedData.userId
                            }}</p>
                        <p *ngIf="scannedData.email" class="truncate"><strong>Email:</strong> {{ scannedData.email }}
                        </p>
                        <p *ngIf="scannedData.eventId" class="truncate"><strong>Event ID:</strong> {{
                            scannedData.eventId }}</p>
                        <p><strong>Scanned:</strong> {{ 'monitor' }}</p>
                        <!-- Date formatting issue in template, just placeholder -->
                    </div>
                </div>

                <div class="flex gap-3">
                    <button (click)="resetScanner()"
                        class="flex-1 flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        <lucide-icon [img]="RefreshCwIcon" class="mr-2 h-4 w-4"></lucide-icon>
                        Scan Another
                    </button>
                    <button (click)="close.emit()"
                        class="flex-1 flex items-center justify-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                        <lucide-icon [img]="CheckCircleIcon" class="mr-2 h-4 w-4"></lucide-icon>
                        Done
                    </button>
                </div>
            </div>

            <!-- Error -->
            <div *ngIf="error" class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-start">
                    <lucide-icon [img]="AlertCircleIcon" class="text-red-600 mr-3 h-5 w-5 mt-0.5"></lucide-icon>
                    <div>
                        <p class="text-red-800 font-medium">Scan Error</p>
                        <p class="text-red-700 text-sm">{{ error }}</p>
                    </div>
                </div>
            </div>

            <!-- Permission Denied -->
            <div *ngIf="hasPermission === false" class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start">
                    <lucide-icon [img]="AlertCircleIcon" class="text-yellow-600 mr-3 h-5 w-5 mt-0.5"></lucide-icon>
                    <div>
                        <p class="text-yellow-800 font-medium">Camera Access Required</p>
                        <p class="text-yellow-700 text-sm">Please allow camera access to scan QR codes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>